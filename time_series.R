############### SESYNC Research Support: Animals Trade project ########## 
##
## 
## DATE CREATED: 05/15/2017
## DATE MODIFIED: 05/26/2017
## AUTHORS: Benoit Parmentier and Elizabeth Daut
## Version: 1
## PROJECT: Animals trade
## ISSUE: 
## TO DO:
##
## COMMIT: fixing bug in theil Sen function
##

###################################################
#

###### Library used

library(xts) #extension for time series object and analyses
library(zoo) # time series object and analysis
library(mblm) #Theil Sen estimator
library(lubridate) 

###### Functions used in this script

functions_time_series_analyses_script <- "time_series_functions_05262017.R" #PARAM 1

script_path <- "/research-home/bparmentier/Data/projects/animals_trade/scripts" #path to script #PARAM 2
source(file.path(script_path,functions_time_series_analyses_script)) #source all functions used in this script 1.


#####  Parameters and argument set up ###########

#ARGS 1
in_dir <- "/research-home/bparmentier/Data/projects/animals_trade"
#ARGS 2
infile_name <- "FB_malaysia_sp_norm.csv"
#ARGS 3
#date_range <- c("2011.01.01","2017.03.01") #
date_range <- c("2011/1/1","2017/4/1")
#ARGS 4
scaling_factor <- 100000
#ARGS 5
out_dir <- "/research-home/bparmentier/Data/projects/animals_trade/outputs" #parent directory where the new output directory is located
#ARGS 6
create_out_dir_param=TRUE #create a new ouput dir if TRUE
#ARGS 7
out_suffix <- "malaysia_time_series_analyses_05242017"

################# START SCRIPT ###############################


### PART I READ AND PREPARE DATA #######
#set up the working directory
#Create output directory

if(is.null(out_dir)){
  out_dir <- in_dir #output will be created in the input dir
  
}
#out_dir <- in_dir #output will be created in the input dir

out_suffix_s <- out_suffix #can modify name of output suffix
if(create_out_dir_param==TRUE){
  out_dir <- create_dir_fun(out_dir,out_suffix)
  setwd(out_dir)
}else{
  setwd(out_dir) #use previoulsy defined directory
}


## Step 1: read in the data and generate time stamps

dates_val <- seq(as.Date(date_range[1]), as.Date(date_range[2]), by="month")
df_dat_animals <- read.table(file.path(in_dir,infile_name),sep=",",header=T)

#test<- df_dat_animals * scaling_factor

dim(df_dat_animals)
#View(df_dat_animals)

### Step 2: Subset and transpose to create
names(df_dat_animals)
dates_years <- year(dates_val)

df_dat <- df_dat_animals[,87:162]*scaling_factor
#df_dat <- subset(df_dat_animals,) #improve later
names_countries <- as.character(df_dat_animals$country)
names_species <- as.character(df_dat_animals$sci_name)
names_species <- sub(" ","_",names_species)

names_col <- paste(names_countries,names_species,sep="_")

### Zoo analyses

df_ts <- t(df_dat) #transpose, the result is a matrix
df_ts <- as.data.frame(df_ts) #coerce in data.frame object
names(df_ts) <- names_col #in this case, country code

df_ts <- zoo(df_ts,dates_val)
plot(df_ts[,1:3])

## Example of windowing by dates
df_w_ts <- window(df_ts,start=as.Date("2016-01-01"),end= as.Date("2017-01-01"))
plot(df_w_ts[,1:3])

df_agg_ts <- aggregate(df_ts, by=as.yearqtr)
df_agg_ts <- aggregate(df_ts, by=year)
class(df_agg_ts)
plot(df_agg_ts[,1:3])
plot(df_agg_ts[,1:3],plot.type="single")

#### Compare quarterly aggregated to original monthly data
par(mfrow=c(2,1))
plot(df_ts[,1])
plot(df_agg_ts[,1],col="red")

## Moving average, smoothing and rollingmean
rollmean_ts <- rollmean(df_ts[,1], 12)
dim(rollmean_ts) #need to fix this

par(mfrow=c(1,1))

plot(rollmean_ts)
plot((df_ts[,1]))

### Theil Sen slope slope calculation

#make this a function later: example with the first country
#debug(calculate_theil_sen_time_series)
mod_mblm_test <- calculate_theil_sen_time_series(i=1,
                                                 data_df=df_ts,
                                                 out_dir=out_dir,
                                                 out_suffix="time_series_analyses_05232017")

#debug(calculate_theil_sen_time_series)  
list_mod_mblm_test <- lapply(1:ncol(df_ts), # input parameter i as a list
                             FUN=calculate_theil_sen_time_series,
                             data_df=df_ts,
                             out_dir=out_dir,
                             out_suffix=out_suffix)

mod_mblm <- list_mod_mblm_test[[3]] #Look at model for the USA

mod_mblm
coef(mod_mblm)

list_theil_sen_obj <- list.files(path=out_dir,pattern="*.RData")

test_obj <- load_obj(list_theil_sen_obj[[1]])
test_obj

########
## Example of windowing by dates

df_w_ts_ref <- window(df_ts,start=as.Date("2016-05-01"),end= as.Date("2016-12-01"))
df_w_ts_current <- window(df_ts,start=as.Date("2017-01-01"),end= as.Date("2017-04-01"))

df_w_ts_combined <- window(df_ts,start=as.Date("2016-05-01"),end= as.Date("2017-04-01"))

plot(df_w_ts_combined[,1]) 
names(df_w_ts_current)[1]

df_w_ts_ref[,1] + df_w_ts_current[,1] 
plot(df_w_ts_current[,1])
plot(df_w_ts_ref[,1])


####
#undebug(calculate_theil_sen_time_series)
mod_mblm_df_w_ts_ref <- calculate_theil_sen_time_series(i=1,
                                                 data_df=df_w_ts_ref,
                                                 out_dir=out_dir,
                                                 out_suffix="time_series_analyses_05232017")

mod_mblm_df_w_ts_current <- calculate_theil_sen_time_series(i=1,
                                                        data_df=df_w_ts_current,
                                                        out_dir=out_dir,
                                                        out_suffix="time_series_analyses_05232017")

plot(df_ts[,1])
nt <- nrow(df_ts)
nt <- 76
##
year_start <- year(date(df_ts)[1])
year_end <- year(date(df_ts)[nt])
#year_start
ts_val <- as.ts(as.numeric(df_ts[1:72,1]),start= year_start,end=year_end,frequency=12)

decompose(ts_val)
rollmean_ts <- rollmean(df_ts[,1:10], 2)
var(rollmean_ts[,1])
var(df_ts[,1])
plot(rollmean_ts[,1])
plot(df_ts[,1])

mod_mblm_rollmean <- calculate_theil_sen_time_series(i=1,
                                                      data_df=rollmean_ts,
                                                      out_dir=out_dir,
                                                      out_suffix="time_series_analyses_05232017")
coef(mod_mblm_rollmean$mod_mblm)

df_ts[1,1]
0.0008147/df_ts[1,1]*100



mod_mblm_df_w_ts_current$



#1. short-term acute increase
#compare the last 4 months (current) to the previous 8 months (ref)
df_w_ts_ref <- window(df_ts,start=as.Date("2016-05-01"),end=as.Date("2016-12-01")) #previous 8 months
df_w_ts_current <- window(df_ts,start=as.Date("2017-01-01"),end=as.Date("2017-04-01")) #last 4 months
df_w_ts_combined <- window(df_ts,start=as.Date("2016-05-01"),end=as.Date("2017-04-01")) #entire test window

#compare the last 4 months (current) to the previous 12 months (ref)
df_w_ts_ref <- window(df_ts,start=as.Date("2016-01-01"),end=as.Date("2016-12-01")) #previous 12 months
df_w_ts_current <- window(df_ts,start=as.Date("2017-01-01"),end=as.Date("2017-04-01")) #last 4 months
df_w_ts_combined <- window(df_ts,start=as.Date("2016-01-01"),end=as.Date("2017-04-01")) #entire test window


#2. long-term steady increase
#compare the last 4 months (current) to the previous 24 months (ref)
df_w_ts_ref <- window(df_ts,start=as.Date("2015-01-01"),end=as.Date("2016-12-01"))
df_w_ts_current <- window(df_ts,start=as.Date("2017-01-01"),end=as.Date("2017-04-01"))
df_w_ts_combined <- window(df_ts,start=as.Date("2015-01-01"),end=as.Date("2017-04-01"))

#compare the last 4 months (current) to the previous 48 months (ref)
df_w_ts_ref <- window(df_ts,start=as.Date("2014-01-01"),end=as.Date("2016-12-01"))
df_w_ts_current <- window(df_ts,start=as.Date("2017-01-01"),end=as.Date("2017-04-01"))
df_w_ts_combined <- window(df_ts,start=as.Date("2014-01-01"),end=as.Date("2017-04-01"))


################### End of script ################
